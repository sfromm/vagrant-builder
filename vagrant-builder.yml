---
- hosts: localhost
  name: build boxes
  connection: local
  gather_facts: no

  tasks:
      - name: create directories
        with_items: virt_builder_images
        file: path="{{builder_dir}}/{{item.name}}" state=directory

      - name: create empty virt-builder index
        command: touch {{builder_dir}}/index creates={{builder_dir}}/index

      - name: copy vagrantfile
        copy: src=Vagrantfile dest={{builder_dir}}/Vagrantfile

      - name: copy virt-builder password
        copy: src=password dest={{builder_dir}}/password

      - name: create vagrant metadata.json
        template: src=metadata.j2 dest={{builder_dir}}/metadata.json

      - name: build images
        with_items: virt_builder_images
        environment:
            LIBGUESTFS_BACKEND: direct
        command: chdir={{builder_dir}}
                 virt-builder {{item.name}}
                 --selinux-relabel
                 --format {{ format }}
                 --size {{ size }}G
                 --output {{item.name}}/box.img
                 --root-password file:{{builder_dir}}/password
                 --run-command {{ item.run_command|join(' --run-command ') }}

# https://github.com/pradels/vagrant-libvirt/tree/master/example_box
      - name: create vagrant box
        with_items: virt_builder_images
        command: chdir={{builder_dir}}
                 tar czf {{item.name}}.box metadata.json Vagrantfile {{item.name}}/box.img
