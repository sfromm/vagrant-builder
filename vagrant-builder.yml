---
- hosts: localhost
  name: build boxes
  connection: local
  gather_facts: no

  tasks:
      - name: create directories
        with_items: virt_builder_images
        file: path="{{builder_dir}}/{{item.name}}" state=directory

      - name: create empty virt-builder index
        command: touch {{builder_dir}}/index creates={{builder_dir}}/index

      - name: copy virt-builder password
        copy: src=password dest={{builder_dir}}/password

      - name: create vagrant metadata.json
        with_items: virt_builder_images
        template: src=metadata.j2 dest={{builder_dir}}/{{item.name}}/metadata.json

      - name: copy vagrantfile
        with_items: virt_builder_images
        copy: src=Vagrantfile dest={{builder_dir}}/{{item.name}}/Vagrantfile

      - name: build images
        with_items: virt_builder_images
        environment:
            LIBGUESTFS_BACKEND: direct
        command: chdir={{builder_dir}}
                 virt-builder {{item.name}}
                 --selinux-relabel
                 --format {{ format }}
                 --size {{ size }}G
                 --output {{item.name}}/box.img
                 --root-password file:{{builder_dir}}/password
                 --run-command {{ item.run_command|join(' --run-command ') }}

# https://github.com/pradels/vagrant-libvirt/tree/master/example_box
      - name: create vagrant box
        with_items: virt_builder_images
        command: chdir={{builder_dir}}/{{item.name}}
                 tar czf {{builder_dir}}/{{item.name}}.box metadata.json Vagrantfile box.img

      - name: get installed boxes
        command: vagrant box list
        register: vagrant_boxes

      - name: install new boxes
        with_items: virt_builder_images
        when: "item.name not in vagrant_boxes.stdout"
        command: vagrant box add --name {{item.name}} {{builder_dir}}/{{item.name}}.box

      - name: upgrade existing boxes
        with_items: virt_builder_images
        when: "item.name in vagrant_boxes.stdout"
        command: vagrant box upgrade --box {{item.name}} {{builder_dir}}/{{item.name}}.box
